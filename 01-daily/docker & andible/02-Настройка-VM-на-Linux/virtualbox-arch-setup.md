# Установка VirtualBox на Arch Linux

Полная инструкция по установке и настройке VirtualBox для хост-системы на Arch Linux со стандартным ядром `linux`.

## Предварительные требования

- Arch Linux с ядром `linux` (проверь: `uname -r`)
- Доступ к `sudo`
- Интернет для скачивания пакетов

---

## Пошаговая установка

### 1. Проверить версию ядра

```bash
uname -r
```

**Что это делает:** выводит текущую версию ядра (например, `6.18.3-arch1-1`).

**Зачем:** убедиться, что используется стандартное ядро `linux`, а не `linux-lts`, `linux-zen` и т.д.

---

### 2. Обновить систему

```bash
sudo pacman -Syu
```

**Что это делает:** обновляет все пакеты и индекс репозиториев.

**Зачем:** гарантирует совместимость пакетов и устраняет возможные проблемы с зависимостями.

---

### 3. Установить заголовочные файлы ядра

```bash
sudo pacman -S linux-headers
```

**Что это делает:** устанавливает исходные коды и заголовочные файлы ядра.

**Зачем:** нужны для корректной компиляции и загрузки модулей ядра VirtualBox. Должны совпадать по версии с установленным ядром.

---

### 4. Установить VirtualBox и host-модули

```bash
sudo pacman -S virtualbox virtualbox-host-modules-arch
```

**Что это делает:** 
- Устанавливает основное приложение VirtualBox
- Устанавливает предкомпилированные модули ядра для стандартного ядра Arch

**Зачем:** 
- `virtualbox` — основная программа для создания и управления виртуальными машинами
- `virtualbox-host-modules-arch` — драйверы ядра, без которых ВМ не могут запуститься

---

### 5. Загрузить модуль ядра в память

```bash
sudo modprobe vboxdrv
```

**Что это делает:** загружает модуль `vboxdrv` в оперативную память.

**Зачем:** после установки пакеты лежат на диске, но ещё не активны в памяти. Эта команда активирует модуль в текущей сессии. При перезагрузке модуль загружается автоматически.

---

### 6. Проверить, что модуль загружен

```bash
lsmod | grep vbox
```

**Что это делает:** выводит список активных модулей ядра, отфильтрованный по `vbox`.

**Ожидаемый вывод:**
```
vboxdrv               667648  0
vboxnetadp            28672  0
vboxnetflt            32768  0
```

**Зачем:** убедиться, что модули успешно загружены в память и готовы к работе.

**Если ничего не вывело:** выполни:
```bash
sudo /sbin/vboxconfig
```

Эта команда пересобирает и перезагружает модули.

---

### 7. Добавить пользователя в группу `vboxusers`

```bash
sudo usermod -aG vboxusers $USER
```

**Что это делает:** добавляет текущего пользователя в группу `vboxusers`.

**Зачем:** даёт права на работу с USB, сетевыми интерфейсами и другими устройствами в ВМ без необходимости использовать `sudo`.

**Важно:** изменение группы применится только после перелогина. Выполни одно из:

```bash
# Вариант 1: выход и вход в систему (самый надёжный)
exit

# Вариант 2: переключение на того же пользователя
su - $USER
```

---

## Опциональная установка

### Установить Guest ISO

Если планируешь устанавливать гостевые ОС и Guest Additions:

```bash
sudo pacman -S virtualbox-guest-iso
```

---

### Установить Extension Pack

Для поддержки USB 2.0/3.0, RDP и других функций (требует AUR):

```bash
yay -S virtualbox-ext-oracle
```

Если `yay` не установлен, сначала установи его или используй другой AUR-helper.

---

## Запуск VirtualBox

После перелогина или перезагрузки VirtualBox полностью готов к работе:

```bash
virtualbox &
```

Либо запусти через меню приложений (rofi, launcher и т.д.).

---

## Диагностика и решение проблем

### Ошибка: "Kernel driver not installed (rc=-1908)"

Это означает, что модуль не загружен. Решение:

```bash
sudo modprobe vboxdrv
sudo /sbin/vboxconfig
```

Затем перезагрузись:

```bash
sudo reboot
```

### Модули не загружаются после обновления ядра

При `pacman -Syu` ядро может обновиться. Перестрой модули:

```bash
sudo vboxreload
```

Или перезагрузись — модули загрузятся автоматически.

### Проверить статус модулей

```bash
lsmod | grep vbox
sudo dmesg | grep vbox
journalctl -xe | grep vbox
```

---

## Дополнительная информация

### Версия ядра и headers должны совпадать

Проверить версии:

```bash
uname -r                    # версия ядра
pacman -Qs linux-headers    # версия headers
```

Они должны совпадать (например, обе `6.18.3-arch1-1`).

### Отключить автозагрузку модулей (если не нужна)

Если не хочешь, чтобы модули загружались при загрузке системы:

```bash
sudo touch /etc/modules-load.d/virtualbox-host-modules-arch.conf
```

После этого модули будут загружаться только вручную через `sudo modprobe vboxdrv`.

### Полезные команды

```bash
# Перестроить все модули VirtualBox
sudo vboxreload

# Просмотреть конфиг автозагрузки
cat /usr/lib/modules-load.d/virtualbox-host-modules-arch.conf

# Просмотреть детальную информацию о модуле
modinfo vboxdrv
```

---

## Краткая шпаргалка

Скопируй и выполни по порядку (если уже был `pacman -Syu`):

```bash
sudo pacman -S linux-headers virtualbox virtualbox-host-modules-arch
sudo modprobe vboxdrv
lsmod | grep vbox
sudo usermod -aG vboxusers $USER

# Перелогинься или перезагрузись
su - $USER

# Запусти VirtualBox
virtualbox &
```

---

## Ссылки и документация

- [Arch Wiki: VirtualBox](https://wiki.archlinux.org/title/VirtualBox)
- [VirtualBox Official Documentation](https://www.virtualbox.org/wiki/Documentation)
- [Arch Linux: Pacman](https://wiki.archlinux.org/title/Pacman)

---

**Последнее обновление:** январь 2026 г.  
**Проверено на:** Arch Linux с ядром `linux` 6.18.3-arch1-1
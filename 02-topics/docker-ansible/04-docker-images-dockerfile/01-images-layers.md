### Docker образы и слои

Структура Docker образов, как они работают и управление ими.

---

#### Что такое Docker Image

**Определение:**
- Образ Docker — это шаблон только для чтения, содержащий всё необходимое для запуска приложения
- Образы состоят из **слоёв (layers)**
- Каждый слой — это набор изменений относительно предыдущего слоя

**Образ содержит:**
- Базовая операционная система (или её часть)
- Приложение и его код
- Зависимости и библиотеки
- Переменные окружения
- Команды для запуска приложения

---

#### Архитектура слоёв

**Immutable слои:**
- Все слои в образе доступны **только для чтения**
- Нельзя изменить существующий слой
- Каждое изменение создаёт новый слой

**Writable layer (при создании контейнера):**
- Контейнер добавляет сверху один слой для записи
- Изменения в контейнере хранятся в этом слое
- При удалении контейнера этот слой тоже удаляется

**Диаграмма слоёв:**
```
┌──────────────────────┐
│  Writable Layer      │  ← Контейнер
│  (при запуске)       │
├──────────────────────┤
│  Layer 6             │  ← Образ (readonly)
├──────────────────────┤
│  Layer 5             │
├──────────────────────┤
│  Layer 4             │
├──────────────────────┤
│  Layer 3             │
├──────────────────────┤
│  Layer 2             │
├──────────────────────┤
│  Layer 1 (Base)      │
└──────────────────────┘
```

---

#### Layer Identifier

**Уникальные идентификаторы:**
- Каждый слой имеет уникальный SHA256 хеш
- Пример: `sha256:abc123def456...`
- Хеш вычисляется на основе содержимого слоя

**Отслеживание слоёв:**
- Docker отслеживает слои и может переиспользовать их
- Если два образа имеют одинаковый слой, он хранится один раз
- Экономит место на диске

---

#### Overlay File System

**Как работает объединение слоёв:**
- Overlay FS объединяет несколько слоёв в один
- Показывает объединённый вид файловой системы
- Быстрое объединение без копирования данных

**Пример Nginx:**
```bash
docker pull nginx
docker history nginx
```

Результат: 6 слоёв Nginx образа:
1. Base Linux (например, Debian)
2. Установка пакетов
3. Конфигурация
4. Установка Nginx
5. Скрипты
6. Точка входа

Размер каждого слоя хранится отдельно.

---

#### Команды для работы с образами

**Просмотр доступных образов:**
```bash
docker image ls                                    # все образы
docker image ls --filter "dangling=false"         # только тегированные
docker image ls --format "{{.Repository}}\t{{.Tag}}\t{{.Size}}"   # кастомный формат
```

**Загрузка образа:**
```bash
docker pull nginx                                  # загрузить из реестра
docker pull nginx:latest                          # конкретный тег
docker pull ubuntu:22.04
```

**Информация об образе:**
```bash
docker inspect nginx                              # JSON со всеми деталями
docker inspect --format '{{.Config.Env}}' nginx   # конкретное поле
```

**История слоёв:**
```bash
docker history nginx                              # показывает все слои и команды
docker history --no-trunc nginx                   # полные команды без обрезки
```

---

#### Сохранение и загрузка образов

**Сохранить образ в файл:**
```bash
docker save nginx > nginx.tar                      # сохранить в tar архив
docker save -o nginx.tar nginx:latest              # с флагом -o
```

**Загрузить образ из файла:**
```bash
docker load < nginx.tar                            # загрузить из архива
docker load -i nginx.tar                           # с флагом -i
```

**Использование:**
- Перенос образов между машинами без реестра
- Резервное копирование образов
- Локальное распространение образов

---

#### Экономия места

**Общие слои:**
```bash
# Если есть два образа с одинаковым базовым слоем
# Docker сохраняет этот слой один раз

docker image ls                    # просмотр образов
sudo du -sh /var/lib/docker/           # общий размер образов
```

**Удаление образов:**
```bash
docker image rm nginx                              # удалить образ
docker image rm nginx:latest ubuntu:22.04          # несколько образов
docker image rm -f nginx                           # принудительное удаление
```

**Висящие образы (dangling images):**
- Образы без имени/тега (остаются после переименования)
- Не используются контейнерами
- Тратят место на диск

```bash
docker image ls -f "dangling=true"                # найти висящие образы
docker image prune                                 # удалить висящие образы
docker image prune -a                              # удалить все неиспользуемые
```

---

#### Практический пример: Nginx

**1. Загрузить образ:**
```bash
docker pull nginx
```

**2. Просмотреть слои:**
```bash
docker history nginx
```

Результат:
```
IMAGE          CREATED      CREATED BY                               SIZE
sha256:12a...  5 days ago   /bin/sh -c #(nop)  CMD ["nginx"...]     0B
sha256:34b...  5 days ago   /bin/sh -c #(nop)  EXPOSE 80            0B
sha256:56c...  5 days ago   /bin/sh -c #(nop)  COPY file:... 1.04kB
sha256:78d...  5 days ago   /bin/sh -c apt-get install -y nginx     45MB
...
```

**3. Информация об образе:**
```bash
docker inspect nginx | head -30
```

**4. Размер образа:**
```bash
docker image ls nginx
# REPOSITORY   TAG      IMAGE ID        SIZE
# nginx        latest   sha256:12a...   187MB
```

---

#### Перенос образа между машинами

**На машине 1 (источник):**
```bash
docker save myapp:1.0 | gzip > myapp-1.0.tar.gz
```

**На машине 2 (назначение):**
```bash
gunzip -c myapp-1.0.tar.gz | docker load
docker image ls   # myapp:1.0 будет в списке
```

---

#### Best Practices

✅ **Используй alpine образы** — меньше размер  
✅ **Кэшируй слои** — изменяющийся код в конце Dockerfile  
✅ **Удаляй неиспользуемые образы** — экономь место  
✅ **Теги для версиций** — легче управлять версиями  
✅ **Анализируй образы** — используй `docker history` и Dive tool  

---

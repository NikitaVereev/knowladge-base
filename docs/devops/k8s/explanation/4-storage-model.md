---
title: 4 Модель хранения данных в Kubernetes
type: explanation
tags: [kubernetes, storage, pv, pvc, storageclass, stateful]
---

Контейнеры в Kubernetes эфемерны: если под перезапустится, данные внутри него (в слое `rw`) исчезнут. Для сохранения данных (Stateful) Kubernetes использует мощную абстракцию, отделяющую **потребность** в диске от **физической реализации**.

---

## 1. Концепция разделения (Decoupling)

В классическом IT админ создает диск и говорит разработчику: *"Вот твой путь `/mnt/data`, используй"*.
В Kubernetes процесс разделен на две роли:

1.  **Администратор/Провайдер:** Создает физические хранилища (диски в облаке, NFS-шары).
2.  **Разработчик:** Создает **запрос** на хранилище: *"Мне нужен диск на 10 ГБ, быстрый"*.

Разработчик не должен знать, *где* и *как* создан диск (AWS EBS, Google Disk, локальный путь). Он просто просит ресурсы.

---

## 2. Основные компоненты

### PersistentVolume (PV) — "Сам диск"
Это ресурс кластера (не привязан к Namespace). Он представляет собой кусок реального хранилища.
*   Аналогия: Вставленная в сервер жесткая флешка.
*   Кем создается: Админом (Static) или автоматически (Dynamic).

### PersistentVolumeClaim (PVC) — "Талон на диск"
Это ресурс в Namespace разработчика. Это **запрос** на хранилище.
*   Аналогия: Талончик, в котором написано "Выдать 5 ГБ места".
*   Кем создается: Разработчиком в yaml-файле приложения.

### StorageClass (SC) — "Тип услуги"
Описывает "классы" обслуживания.
*   Примеры: `fast` (SSD), `slow` (HDD), `standard` (Cloud Disk).
*   Функция: Позволяет **динамически** создавать PV. Когда появляется PVC с просьбой "дай 10 ГБ класса `standard`", StorageClass идет к облачному провайдеру, заказывает диск, создает PV и отдает его.

---

## 3. Жизненный цикл (Lifecycle)

### Вариант А: Статический (Static Provisioning)
*Старая школа. Используется редко, в основном для NFS.*

1.  **Admin:** Создает вручную 10 PV (дисков) по 10 ГБ каждый.
2.  **Dev:** Создает PVC с запросом "хочу 10 ГБ".
3.  **K8s:** Ищет свободный PV, который подходит по размеру, и связывает (**Binding**) их вместе.
4.  **Pod:** Использует PVC как обычный Volume.

### Вариант Б: Динамический (Dynamic Provisioning)
*Современный стандарт.*

1.  **Admin:** Создает один раз `StorageClass` (например, `gp2` в AWS).
2.  **Dev:** Создает PVC: "Хочу 10 ГБ из класса `gp2`".
3.  **K8s (Provisioner):**
    *   Видит PVC.
    *   Звонит в API AWS: "Создай диск на 10 ГБ".
    *   Создает объект PV в кластере.
    *   Связывает PV и PVC.
4.  **Pod:** Монтирует диск.

---

## 4. Режимы доступа (Access Modes)

При заказе диска (PVC) важно указать, как он будет использоваться. Не все диски поддерживают все режимы.

| Режим | Сокращение | Описание | Пример |
| :--- | :--- | :--- | :--- |
| **ReadWriteOnce** | **RWO** | Чтение/Запись **одним узлом**. (Даже если на узле 10 подов — они могут читать). | AWS EBS, Google PD, обычный диск. |
| **ReadWriteMany** | **RWX** | Чтение/Запись **многими узлами** одновременно. | NFS, CephFS, Cloud Filestore. |
| **ReadOnlyMany** | **ROX** | Только чтение **многими узлами**. | ConfigMap, Secrets, расшаренные базы знаний. |

> **Внимание:** Вы не можете смонтировать обычный AWS EBS диск к двум разным нодам (режим RWX) — физика облака не позволит. Для этого нужен NFS.

---

## 5. Reclaim Policy (Политика возврата)

Что происходит с физическим диском (PV), когда разработчик удаляет заявку (PVC)?

1.  **Retain (Удержать):** PV переходит в статус `Released`, но данные остаются. Админ должен вручную очистить диск и удалить PV.
2.  **Delete (Удалить):** (Стандарт для облаков) Физический диск в облаке удаляется вместе с данными.
3.  **Recycle:** (Устарело) Делает `rm -rf /` на диске и возвращает в пул свободных.

---

## Связь с подом
В манифесте пода вы ссылаетесь не на PV, а на PVC:

```yaml
volumes:
  - name: my-data
    persistentVolumeClaim:
      claimName: my-db-pvc  # <-- Ссылка на "Талон"
```

Kubernetes сам найдет, какой PV привязан к этому PVC, и смонтирует его в контейнер.

---
title: 3 Операции с образами
description: Продвинутая работа с Docker Images - анализ слоев (history), оффлайн-перенос (save/load), мультиплатформенная сборка (buildx) и глубокая очистка.
---

## 1. Поиск и Анализ

### Поиск и Скачивание
```bash
# Скачать конкретную версию (всегда указывайте тег, избегайте latest!)
docker pull postgres:15-alpine

# Посмотреть список локальных образов
docker images
```

### Анализ размера (History)
Почему образ весит 500 МБ? Команда показывает, сколько весит каждый слой и какой командой он был создан.
```bash
docker history postgres:15-alpine
# Вывод покажет SIZE каждого слоя. Если видите огромный слой, смотрите команду.
```
*Совет*: Используйте утилиту `dive` для визуального анализа (она не встроенная, но стандарт де-факто).

## 2. Сборка (Build)

### Сборка с тегированием
```bash
# -t задает имя:тег. Точка (.) указывает на контекст.
docker build -t my-app:v1 .
```

### Использование ARG (Build-time variables)
Передача переменных, доступных *только* во время сборки (не в рантайме).
```bash
docker build --build-arg APP_VERSION=2.0 -t my-app:v2 .
```

### Сборка конкретного этапа (Multi-stage)
Если в Dockerfile несколько стадий (`AS builder`, `AS runner`), можно собрать только промежуточную (например, для запуска тестов).
```bash
docker build --target builder -t my-app-tests .
```

### Сборка без кеша
Если нужно принудительно пересобрать всё (например, чтобы подтянуть обновления `apt-get update`).
```bash
docker build --no-cache -t my-app .
```

## 3. Очистка и Обслуживание

### Удаление образов
```bash
# Удалить по имени
docker rmi my-app:v1

# Удалить dangling (образы <none>, которые потеряли имя после пересборки)
docker image prune
```

### Полная очистка (Space Reclaim)
Осторожно! Удалит ВСЕ образы, которые сейчас не используются запущенными контейнерами.
```bash
docker image prune -a
```

## 4. Оффлайн-транспортировка (Save/Load)
Как перенести образ на сервер, где нет интернета?

```bash
# 1. Экспорт образа в tar-архив
docker save -o my-app.tar my-app:v1

# 2. Передача файла (scp, флешка)
scp my-app.tar user@server:/tmp/

# 3. Импорт архива в Docker на другом сервере
docker load -i /tmp/my-app.tar
```

## 5. Мультиплатформенная сборка (Buildx)
Если вы на Mac M1 (arm64), а сервер на Linux (amd64), обычный билд создаст образ, который **не запустится** на сервере (`Exec format error`).

Используйте `buildx` для кросс-компиляции:

```bash
# Создать билдер (нужно один раз)
docker buildx create --use

# Собрать и сразу запушить (buildx не хранит мульти-арч образы локально в docker images)
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  -t user/my-app:v1 \
  --push .
```
Это создаст **Manifest List** в реестре, и клиенты сами скачают нужную версию.

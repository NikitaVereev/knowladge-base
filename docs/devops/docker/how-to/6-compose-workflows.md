---
title: 6 Рабочие процессы Compose (Advanced)
description: Полный гайд по docker-compose v2 - частичные рестарты, профили, watch-mode, валидация конфигов, решение проблем с orphaned-контейнерами и масштабирование.
---

## 1. Повседневный цикл (Dev Loop)

### Умный перезапуск (Smart Recreate)
Главная команда разработчика.
```bash
docker compose up -d --build
```
*   `--build`: Принудительно пересобирает образы, если исходники изменились.
*   **Логика**: Docker пересоздаст только те контейнеры, у которых изменился образ или конфигурация в YAML. База данных (если её не трогали) не перезагрузится.

### Изолированный рестарт сервиса
Если вы поправили конфиг Nginx или код бэкенда.
```bash
# 1. Пересобрать только один сервис
docker compose build backend

# 2. Пересоздать контейнер (без остановки остальных)
docker compose up -d --no-deps backend
```
Флаг `--no-deps` критичен: он говорит "не пытайся перезапустить базу данных, даже если бэкенд от неё зависит".

### Live Logs (Слежение)
```bash
# Логи конкретных сервисов "хвостом"
docker compose logs -f --tail=100 backend nginx
```

## 2. Профили и Группировка (Profiles)

Если в `compose.yaml` определены профили (например, `tools` для phpmyadmin/pgadmin или `test` для Cypress), они не запускаются по умолчанию.

```bash
# Посмотреть, какие сервисы и профили доступны
docker compose config --services

# Запустить основной стек + инструменты администрирования
docker compose --profile tools up -d

# Запустить всё, что есть
docker compose --profile "*" up -d
```

## 3. Синхронизация кода (Docker Compose Watch)
*Требует Docker Compose v2.22+*
Новая альтернатива Bind Mounts. Вы описываете правила в `compose.yaml` (раздел `x-develop`), и Docker сам следит за файлами.

```bash
# Запуск в режиме наблюдения
docker compose up --watch
```
*   **Sync**: Просто копирует файл внутрь (для html/css/js).
*   **Rebuild**: Автоматически пересобирает образ при изменении `package.json`.

## 4. Обслуживание и CI/CD

### Валидация конфига
Перед тем как пушить, проверьте, что YAML валиден и переменные подставляются корректно.
```bash
docker compose config
```
Выведет итоговый YAML с подставленными значениями из `.env`.

### Обновление образов (Pull)
Как обновить стек, если образы обновились в реестре (например, `postgres:15` выпустил патч)?
```bash
docker compose pull
docker compose up -d
```

### Очистка "Сирот" (Orphans)
Если вы переименовали сервис в YAML (например, `db` -> `database`), старый контейнер `project_db_1` останется висеть и занимать порты.
Docker предупредит: `Found orphan containers`.

```bash
# Удалить старые контейнеры, которых больше нет в конфиге
docker compose up -d --remove-orphans
```

## 5. Выполнение команд (Run vs Exec)

### Exec (В уже работающий)
```bash
# Зайти в shell базы данных
docker compose exec db bash
```

### Run (В новый, чистый)
Запускает **новый** контейнер с тем же конфигом, что и сервис. Полезно для утилит, которые не должны висеть в фоне.
```bash
# Запустить тесты в изолированном контейнере и удалить его после (--rm)
docker compose run --rm tests npm test
```
*Внимание*: `run` по умолчанию не пробрасывает порты на хост (чтобы не конфликтовать с основным сервисом). Если нужно — используйте `--service-ports`.

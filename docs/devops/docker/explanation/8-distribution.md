---
title: 8 Дистрибуция - Реестры и OCI
description: Как устроено хранение и распространение образов? Anatomy of a Registry, теги против дайджестов (Tags vs Digests) и мульти-архитектурные образы.
---

## Что такое Registry?

**Registry (Реестр)** — это серверное приложение для хранения и раздачи Docker-образов.
Это не просто FTP-сервер. Реестр реализует спецификацию **OCI Distribution Spec**, которая позволяет эффективно хранить слои (дедупликация) и управлять правами доступа.

Когда вы делаете `docker pull nginx`, вы на самом деле обращаетесь к `index.docker.io/library/nginx:latest`.

### Иерархия
1.  **Registry Host**: `docker.io` (Docker Hub), `ghcr.io` (GitHub), `private.corp.com`.
2.  **Namespace**: Группировка. Обычно имя пользователя или организации. `library` — для официальных образов.
3.  **Repository**: Имя образа (например, `nginx`).
4.  **Tag**: Версия (`latest`, `1.21`).

## Mutability: Теги против Дайджестов

Это критический концепт для стабильности продакшена.

### Теги (Tags) — Изменяемые
Тег `v1.0` — это просто указатель.
Сегодня автор образа может запушить под тегом `v1.0` одну версию кода. Завтра он найдет баг, пересоберет образ и запушит его снова как `v1.0`.
*   **Риск**: Ваш сервер сегодня скачает одну версию, а завтра (при масштабировании) — другую. Билд перестает быть воспроизводимым.

### Дайджесты (Digests) — Неизменяемые
Образ можно "пригвоздить" (pin) по хешу содержимого (SHA256).
`nginx@sha256:45b23dee08af5e43a7fea6c4cf9c25ccf269ee113168c19722f87876677c5cb2`
*   **Гарантия**: Этот хеш всегда будет отдавать один и тот же байт-код. Если байт изменится — изменится хеш.

**Best Practice**: В Kubernetes и критичных системах часто используют дайджесты или настраивают полиси "Immutable Tags" в своем приватном реестре.

## Multi-arch Images (Manifest Lists)

Как работает магия, когда вы пишете `FROM node:20` и на Mac M1 (ARM64), и на сервере Intel (AMD64) всё работает?

Реестр поддерживает **Manifest Lists** (или OCI Indexes).
Тег `node:20` указывает не на образ, а на **список**:
*   "Если клиент `linux/amd64` -> отдай манифест `sha256:abc...`"
*   "Если клиент `linux/arm64` -> отдай манифест `sha256:xyz...`"

Docker CLI сам определяет архитектуру хоста и запрашивает нужный слой. Поэтому важно при кросс-платформенной сборке (buildx) пушить именно мульти-арч манифест.

## Виды Реестров

1.  **Public (Docker Hub)**: Огромная база. Есть лимиты на скачивание (Rate Limits) для анонимов.
2.  **Cloud Managed (ECR, GCR, ACR)**: Реестры от AWS/Google/Azure. Интегрированы с IAM (правами доступа облака). Самый надежный вариант для энтерпрайза.
3.  **Self-Hosted (Harbor, Nexus)**: Если нельзя хранить код в облаке. Harbor дополнительно умеет сканировать образы на уязвимости (CVE) и реплицировать их между дата-центрами.

---
title: 2 Образы и слои файловой системы
type: explanation
tags: [docker, images, layers, unionfs, overlay2, copy-on-write]
---

# Образы и слои файловой системы

Docker использует слоистую архитектуру для хранения образов и запуска контейнеров. Это позволяет радикально экономить дисковое пространство и ускорять сборку/передачу данных по сети. Понимание того, как работают слои и драйвер хранения (Storage Driver), необходимо для оптимизации размера образов и понимания производительности операций ввода-вывода (I/O).

## Строение Docker Image

Docker Image — это неизменяемый (immutable) шаблон, состоящий из набора слоев, доступных только для чтения (Read-Only).

Каждый слой представляет собой набор изменений файловой системы (delta) относительно предыдущего слоя: добавление, изменение или удаление файлов.

### Как формируются слои
Слои создаются инструкциями в `Dockerfile`:
1.  **Base Layer**: Обычно создается инструкцией `FROM` (например, `ubuntu:22.04`). Это корневая файловая система (rootfs), содержащая библиотеки и утилиты ОС, но без ядра (ядро используется хостовое).
2.  **Intermediate Layers**: Инструкции `RUN`, `COPY`, `ADD` создают новые слои поверх базового.
3.  **Metadata**: Инструкции `ENV`, `EXPOSE`, `CMD` изменяют конфигурацию образа (metadata), но создают "пустые" слои с точки зрения файловой системы (в современных версиях Docker они могут объединяться).

## Union File System (UnionFS)

Чтобы представить набор разрозненных слоев как единую файловую систему, Docker использует технологию **Union Mount** (объединяющее монтирование).

Современным стандартом является драйвер **overlay2** (в Linux).

### Принцип работы Overlay2
OverlayFS объединяет несколько директорий (слоев) в одну точку монтирования:
*   **LowerDir**: Список слоев образа (Read-Only). Располагаются друг над другом.
*   **UpperDir**: Слой контейнера (Read-Write). Изначально пустой.
*   **Merged**: Единое представление, которое видит процесс внутри контейнера.

Если файл существует в нескольких слоях, "побеждает" (виден) файл из самого верхнего слоя.

## Container Layer и Copy-on-Write (CoW)

Когда вы запускаете контейнер (`docker run`), Docker не копирует весь образ. Вместо этого он берет стопку Read-Only слоев образа и добавляет сверху **один тонкий слой для записи** (Container Layer).

Все изменения, которые процесс делает во время работы контейнера, записываются только в этот верхний слой.

### Стратегия Copy-on-Write (CoW)
Эта стратегия обеспечивает эффективность работы с файлами:

1.  **Чтение (Read)**: Если процесс хочет прочитать файл, Docker ищет его сверху вниз (сначала в container layer, затем в слоях образа). Чтение происходит напрямую, без накладных расходов.
2.  **Запись (Write)**:
    *   **Новый файл**: Записывается сразу в Container Layer.
    *   **Изменение существующего**: Если файл лежит в Read-Only слое (образе), драйвер сначала **копирует** этот файл целиком в Container Layer (UpperDir), и только потом процесс модифицирует эту копию. Оригинал в "нижнем" слое остается нетронутым.
    *   **Удаление**: Файл не удаляется физически из Read-Only слоя. Вместо этого в Container Layer создается специальный маркер (whiteout file), который "скрывает" файл из объединенного представления.

> **Важно:** Из-за CoW интенсивная запись в существующие большие файлы внутри контейнера может быть медленной при первом обращении (из-за операции копирования). Для данных с интенсивной записью (БД) всегда следует использовать **Volumes**, которые обходят механизм UnionFS.

## Идентификация: Теги и Дайджесты

Образы адресуются двумя способами:

1.  **Tag (Мутабельная ссылка)**: Человекочитаемое имя, например `nginx:latest` или `myapp:v1`. Тег — это просто указатель. Разработчик может пересобрать образ и запушить его под тем же тегом `v1`. Это удобно, но не гарантирует воспроизводимость.
2.  **Digest (Иммутабельный идентификатор)**: Хеш содержимого образа (обычно SHA256), например `nginx@sha256:ae32...`. Дайджест гарантирует, что вы получите бит-в-бит тот же образ, независимо от времени и места скачивания.

## Dangling и Intermediate Images

В процессе работы на хосте могут скапливаться "мусорные" слои.

*   **Intermediate Images**: Слои, которые являются родителями для других образов. Они необходимы и не удаляются автоматически. В списке `docker images -a` они могут отображаться без тегов, но они используются.
*   **Dangling Images (`<none>:<none>`)**: Образы, которые потеряли связь с тегом.
    *   *Сценарий появления:* Вы собрали образ `app:v1`. Затем изменили код и собрали новый `app:v1`. Старый образ (предыдущий хеш) потерял имя `app:v1` и стал "повисшим" (dangling).
    *   Они занимают место и безопасны для удаления (`docker image prune`).

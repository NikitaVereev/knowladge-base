---
title: "4 Анатомия Ansible Playbook"
description: "Структура YAML файла: Play, Tasks, Handlers, Vars. Порядок выполнения задач."
---

Playbook — это сценарий автоматизации, описанный в формате YAML. Он говорит Ansible **что** делать (Tasks) и **где** это делать (Hosts).

## Структура Playbook

Один файл может содержать несколько сценариев (Plays). Каждый Play применяет набор ролей и задач к группе хостов.

```yaml
***
- name: Настройка веб-серверов   # <-- Play 1
  hosts: webservers
  become: yes                    # <-- Выполнять от root (sudo)
  vars:
    http_port: 80
  
  tasks:
    - name: Установить Nginx     # <-- Task 1
      apt:
        name: nginx
        state: present
      notify: Restart Nginx      # <-- Триггер хендлера

  handlers:                      # <-- Обработчики
    - name: Restart Nginx
      service:
        name: nginx
        state: restarted
```

## Основные компоненты

### 1. Play (Сценарий)
Связывает группу хостов (`hosts`) с задачами (`tasks`). Определяет контекст выполнения (пользователь, sudo).

### 2. Tasks (Задачи)
Список действий, выполняемых последовательно сверху вниз. Каждая задача вызывает модуль Ansible. Если задача падает, выполнение для этого хоста останавливается.

### 3. Handlers (Обработчики)
Специальные задачи, которые запускаются **только если** их уведомили (`notify`) и **только если** уведомляющая задача внесла изменения (`changed`). Они выполняются **один раз** в самом конце Play.

## Порядок выполнения
1.  **Gather Facts:** Сбор фактов о системе (если не отключено `gather_facts: no`).
2.  **Pre Tasks:** Задачи секции `pre_tasks`.
3.  **Roles:** Задачи из подключенных ролей.
4.  **Tasks:** Основные задачи плейбука.
5.  **Post Tasks:** Задачи секции `post_tasks`.
6.  **Handlers:** Запускаются в конце ("flush handlers"), но можно вызвать принудительно через meta-задачу `flush_handlers`.

---
title: "4 Ansible Best Practices"
description: "Свод правил по написанию поддерживаемого, идемпотентного и чистого кода."
---

Соблюдение этих правил спасет вам часы отладки в будущем.

## 1. Структура и Организация

### Используйте Роли
Не пишите монолитные плейбуки. Как только логика становится сложнее "установить пакет и запустить сервис", выносите её в роль.
*   **Плохо:** `site.yml` на 500 строк.
*   **Хорошо:** `site.yml` вызывает `roles/nginx` и `roles/db`.

### Именование переменных
Ansible имеет плоское пространство имен. Переменная `port` в одной роли перезапишет `port` в другой.
*   **Плохо:** `port`, `user`, `package`.
*   **Хорошо:** `nginx_port`, `postgres_user`, `app_package_name`.

## 2. Качество кода и Линтинг

Всегда используйте `ansible-lint`. Это статический анализатор, который найдет ошибки до запуска.

```bash
pip install ansible-lint
ansible-lint site.yml
```

### Частые ошибки:
*   **Использование Shell вместо модулей.**
    *   *Плохо:* `shell: git clone ...`
    *   *Хорошо:* `git: repo=...`
*   **Отсутствие `name`.** Каждая задача должна иметь человекочитаемое описание.

## 3. Идемпотентность

Плейбук должен быть безопасен для повторного запуска.

**Проблема Shell-команд:**
```yaml
- shell: echo "export FOO=bar" >> ~/.bashrc
```
При каждом запуске файл `.bashrc` будет расти.

**Решение (Lineinfile):**
```yaml
- lineinfile:
    path: ~/.bashrc
    line: "export FOO=bar"
    state: present
```

## 4. Безопасность

*   **Никогда не храните секреты в открытом виде.** Используйте **Ansible Vault**.
*   **Не отключайте проверку хостов (Host Key Checking)** в продакшене.
*   **Используйте `no_log: true`** для задач, которые работают с паролями, чтобы они не попали в лог.
